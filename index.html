<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Baseline History Tree (Sub-Grid)</title>
<style>
body { font-family: Arial, sans-serif; }
.grid-line { stroke: #e0e0e0; stroke-width: 1px; }
.node circle { stroke: #333; stroke-width: 1.5px; }
.node text { font-size: 12px; text-anchor: middle; pointer-events: none; }
.link { fill: none; stroke: #666; stroke-width: 2px; marker-end: url(#arrow); }
</style>
</head>
<body>
<h2>Baseline History Tree (Sub-Grid)</h2>
<svg width="1400" height="900"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const width = 1400;
const height = 900;
const svg = d3.select("svg");

// Arrowhead
svg.append("defs").append("marker")
  .attr("id", "arrow")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 20)
  .attr("refY", 0)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
.append("path")
  .attr("d", "M0,-5L10,0L0,5")
  .attr("fill", "#666");

// Zoomable container
const gZoom = svg.append("g");
svg.call(
  d3.zoom().scaleExtent([0.3,4]).on("zoom", e => gZoom.attr("transform", e.transform))
);

// Load JSON
d3.json("baseline_history.json").then(data => {
    const nodes = data.nodes;
    const links = data.links;
    const cellW = 160;
    const cellH = 90;
    const trunkX = width / 2;
    const trunkY0 = height - 80;

    const nodeById = new Map(nodes.map(n=>[n.id,n]));

    // Mainline nodes
    const mainline = nodes.filter(n=>n.mainline);
    mainline.forEach((n,i)=>{
        n.gridX=0; n.gridY=i; n.dir=0;
        n.x = trunkX; n.y = trunkY0 - i*cellH;
    });

    // Side branches
    let branchCount=0;
    const branchDir = new Map();
    const processed = new Set();

    function assignSubGrid(n){
        if(processed.has(n.id)) return;
        processed.add(n.id);

        const preds = n.predecessors.map(pid=>nodeById.get(pid));
        if(n.mainline) return;

        // --- branch root from trunk
        const trunkPred = preds.find(p=>p.mainline);
        if(trunkPred){
            branchCount++;
            const dir = (branchCount%2===0)?-1:1;
            branchDir.set(n.id, dir);
            n.dir = dir;
            n.gridX = dir;
            n.gridY = trunkPred.gridY;
        } else {
            // continuation or sub-branch
            const p = preds[0];
            assignSubGrid(p);
            n.dir = p.dir;
            n.gridX = p.gridX + (p.mainline?0:1*p.dir); // increment X for sub-branch
            // gridY = average of predecessors + fractional offset
            n.gridY = preds.reduce((sum,d)=>sum+d.gridY,0)/preds.length + 0.3;
        }

        n.x = trunkX + n.gridX*cellW;
        n.y = trunkY0 - n.gridY*cellH;
    }

    nodes.forEach(assignSubGrid);

    // Draw grid
    const minGX = Math.floor(d3.min(nodes,d=>d.gridX)-1);
    const maxGX = Math.ceil(d3.max(nodes,d=>d.gridX)+1);
    const minGY = -1;
    const maxGY = Math.ceil(d3.max(nodes,d=>d.gridY)+1);

    for(let gx=minGX;gx<=maxGX;gx++){
        gZoom.append("line")
            .attr("class","grid-line")
            .attr("x1",trunkX+gx*cellW)
            .attr("y1",trunkY0-minGY*cellH)
            .attr("x2",trunkX+gx*cellW)
            .attr("y2",trunkY0-maxGY*cellH);
    }
    for(let gy=minGY;gy<=maxGY;gy++){
        gZoom.append("line")
            .attr("class","grid-line")
            .attr("x1",trunkX+minGX*cellW)
            .attr("y1",trunkY0-gy*cellH)
            .attr("x2",trunkX+maxGX*cellW)
            .attr("y2",trunkY0-gy*cellH);
    }

    // Draw links
    gZoom.selectAll(".link")
        .data(links)
        .enter()
        .append("path")
        .attr("class","link")
        .attr("d", d=>{
            const s = nodeById.get(d.source);
            const t = nodeById.get(d.target);
            const cx = (s.x+t.x)/2;
            return `M${s.x},${s.y} C${cx},${s.y} ${cx},${t.y} ${t.x},${t.y}`;
        });

    // Draw nodes
    const g = gZoom.selectAll(".node")
        .data(nodes)
        .enter()
        .append("g")
        .attr("class","node")
        .attr("transform", d=>`translate(${d.x},${d.y})`);

    g.append("circle")
        .attr("r",22)
        .attr("fill", d=>d.mainline?"#1f77b4":"#ff7f0e");

    g.append("text")
        .attr("dy",-6)
        .text(d=>d.baselines.map(b=>b.name).join(", "));

    g.append("text")
        .attr("dy",10)
        .attr("font-size","10px")
        .attr("fill","#555")
        .text(d=>d.gridX.toFixed(1)+"/"+d.gridY.toFixed(1));
});
</script>
</body>
</html>
